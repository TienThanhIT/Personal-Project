S<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Th·ª±c Hi·ªán Cho M∆∞·ª£n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">Qu·∫£n L√Ω Th∆∞ Vi·ªán</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/nhap-sach">Nh·∫≠p S√°ch</a>
                <a class="nav-link" href="/doc-gia">ƒê·ªôc Gi·∫£</a>
                <a class="nav-link active" href="/muon-sach">M∆∞·ª£n S√°ch</a>
                <a class="nav-link" href="/thong-ke">B√°o C√°o</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card mx-auto" style="max-width: 600px;">
            <div class="card-header bg-warning text-dark">üìã L·∫≠p Phi·∫øu M∆∞·ª£n S√°ch</div>
            <div class="card-body">
                <form id="formMuon">
                    <div class="mb-3">
                        <label class="form-label">T√™n ƒê·ªôc Gi·∫£:</label>
                        <input type="text" id="searchDocGia" class="form-control" placeholder="G√µ t√™n ƒë·ªÉ t√¨m..." autocomplete="off">
                        <input type="hidden" id="selected_docgia_id"> <div id="suggestDocGia" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">M√£ S√°ch:</label>
                        <input type="text" id="book_id" class="form-control" placeholder="V√≠ d·ª•: S001" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">H·∫°n Tr·∫£:</label>
                        <input type="date" id="han_tra" class="form-control" required>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">X√°c Nh·∫≠n Cho M∆∞·ª£n</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const inputSearch = document.getElementById('searchDocGia');
        const suggestDiv = document.getElementById('suggestDocGia');
        const hiddenId = document.getElementById('selected_docgia_id');

        // G·ª£i √Ω t√™n ƒë·ªôc gi·∫£ khi g√µ
        inputSearch.oninput = async () => {
            const query = inputSearch.value;
            if (query.length < 2) { suggestDiv.innerHTML = ''; return; }

            const res = await fetch(`/api/tim-doc-gia?name=${query}`);
            const data = await res.json();

            suggestDiv.innerHTML = data.map(dg => `
                <button type="button" class="list-group-item list-group-item-action" 
                        onclick="selectDG('${dg.hoten}', ${dg.docgia_id})">
                    ${dg.hoten} (ID: ${dg.docgia_id})
                </button>
            `).join('');
        };

        window.selectDG = (name, id) => {
            inputSearch.value = name;
            hiddenId.value = id;
            suggestDiv.innerHTML = '';
        };

        // G·ª≠i form m∆∞·ª£n s√°ch
        document.getElementById('formMuon').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                book_id: document.getElementById('book_id').value,
                docgia_id: hiddenId.value,
                han_tra: document.getElementById('han_tra').value
            };

            const res = await fetch('/api/muon-sach', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            alert(result.message || result.error);
        };
    </script>
</body>
</html>
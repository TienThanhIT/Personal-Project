<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kho Sách</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
</head>
<body>
<header class="web-header">
    <div class="header-content">
        <h1 class="logo">THƯ VIỆN TRƯỜNG CHÍNH TRỊ CẦN THƠ</h1>
    </div>
</header>

<nav id="sidebar">
    <ul class="list-unstyled components">
        <li><a href="/dashboard.html"><i class="bi bi-house-door"></i> Trang chủ</a></li>
        <li><a href="/muon.html"><i class="bi bi-person-plus-fill"></i> Cho mượn sách</a></li>
        <li><a href="/dsmuon.html"><i class="bi bi-list-columns-reverse"></i> Đang mượn</a></li>
        <li><a href="/lstra.html"><i class="bi bi-clock-history"></i> Lịch sử trả</a></li>
        <li class="active"><a href="/khosach.html"><i class="bi bi-archive"></i> Kho sách</a></li>
        <hr class="mx-3 border-secondary">
    </ul>
</nav>

<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-success">Quản lý Kho sách</h3>
    </div>

    <div class="card p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="search-box mb-0" style="flex-grow: 1; max-width: 400px;">
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                    <input type="text" id="searchInKho" class="form-control" placeholder="Tìm tên sách, mã sách, tác giả...">
                </div>
            </div>

            <div class="d-flex gap-2 ms-3">
                <button onclick="exportKhoSach()" class="btn btn-success d-flex align-items-center">
                    <i class="bi bi-file-earmark-excel me-2"></i> Xuất Excel
                </button>
                <a href="/nhapsach.html" class="btn btn-primary d-flex align-items-center">
                    <i class="bi bi-plus-lg me-2"></i> Thêm sách mới
                </a>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>Mã sách</th>
                        <th>Tiêu đề</th>
                        <th>Thể loại</th>
                        <th>Tác giả</th>
                        <th class="text-center">Số lượng</th>
                        <th class="text-center">Còn lại</th>
                        <th class="text-center">Thao tác</th>
                    </tr>
                </thead>
                <tbody id="bookTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Cập nhật thông tin sách</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="edit_book_id">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tiêu đề sách</label>
                        <input type="text" id="edit_tieude" class="form-control" required>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label fw-bold">Thể loại</label>
                            <input type="text" id="edit_theloai" class="form-control">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label fw-bold">Tác giả</label>
                            <input type="text" id="edit_tacgia" class="form-control">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">Lưu thay đổi</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 1. Cấu hình Toast
    const Toast = Swal.mixin({
        toast: true,
        position: 'bottom-end',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true
    });

    let modalInstance;

    // 2. Khởi tạo trang
    window.onload = function() {
        modalInstance = new bootstrap.Modal(document.getElementById('editModal'));
        loadBooks();
    };

    // 3. Tải dữ liệu từ API
    async function loadBooks() {
        try {
            const res = await fetch('/api/kho-sach');
            const books = await res.json();
            renderTable(books);
        } catch (err) {
            console.error("Lỗi:", err);
            Toast.fire({ icon: 'error', title: 'Không thể tải dữ liệu kho!' });
        }
    }

    // 4. Hiển thị bảng dữ liệu
    function renderTable(data) {
        const body = document.getElementById('bookTableBody');
        if (!data || data.length === 0) {
            body.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-3">Kho sách trống</td></tr>`;
            return;
        }
        
        body.innerHTML = data.map(book => `
            <tr>
                <td><span class="badge bg-secondary">${book.book_id}</span></td>
                <td class="fw-bold">${book.tieude}</td>
                <td>${book.theloai || '-'}</td>
                <td>${book.tacgia || '-'}</td>
                <td class="text-center">${book.tongso}</td>
                <td class="text-center text-primary fw-bold">${book.conlai}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary me-1" onclick='openEditModal(${JSON.stringify(book)})'>
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteBook('${book.book_id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // 5. Mở modal chỉnh sửa
    function openEditModal(book) {
        document.getElementById('edit_book_id').value = book.book_id;
        document.getElementById('edit_tieude').value = book.tieude;
        document.getElementById('edit_theloai').value = book.theloai || '';
        document.getElementById('edit_tacgia').value = book.tacgia || '';
        modalInstance.show();
    }

    // 6. Lưu dữ liệu đã sửa
    async function saveEdit() {
        const id = document.getElementById('edit_book_id').value;
        const payload = {
            tieude: document.getElementById('edit_tieude').value,
            theloai: document.getElementById('edit_theloai').value,
            tacgia: document.getElementById('edit_tacgia').value,
            tongso: parseInt(document.getElementById('edit_tongso').value),
            conlai: parseInt(document.getElementById('edit_conlai').value)
        };

        try {
            const res = await fetch(`/api/sua-sach/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                Toast.fire({ icon: 'success', title: 'Đã cập nhật thông tin!' });
                modalInstance.hide();
                loadBooks();
            } else {
                Toast.fire({ icon: 'error', title: 'Lỗi khi lưu dữ liệu!' });
            }
        } catch (err) {
            Toast.fire({ icon: 'error', title: 'Lỗi kết nối Server!' });
        }
    }

    // 7. Xóa sách
    async function deleteBook(book_id) {
        const result = await Swal.fire({
            title: 'Xác nhận xóa?',
            text: "Dữ liệu sách này sẽ bị xóa vĩnh viễn!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Đúng, xóa nó!',
            cancelButtonText: 'Hủy'
        });

        if (result.isConfirmed) {
            try {
                const res = await fetch(`/api/xoa-sach/${book_id}`, { method: 'DELETE' });
                if (res.ok) {
                    Swal.fire('Thành công!', 'Sách đã được xóa khỏi kho.', 'success');
                    loadBooks();
                } else {
                    Swal.fire('Lỗi!', 'Không thể xóa sách đang có người mượn.', 'error');
                }
            } catch (err) {
                Swal.fire('Lỗi!', 'Lỗi kết nối hệ thống.', 'error');
            }
        }
    }

    // 8. Tìm kiếm nhanh
    document.getElementById('searchInKho').oninput = function(e) {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('#bookTableBody tr').forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
        });
    };

    // 9. Xuất Excel
    async function exportKhoSach() {
        try {
            const res = await fetch('/api/kho-sach');
            const data = await res.json();
            if (data.length === 0) return Toast.fire({ icon: 'warning', title: 'Không có dữ liệu!' });

            const excelData = data.map(item => ({
                "Mã sách": item.book_id,
                "Tiêu đề": item.tieude,
                "Thể loại": item.theloai || "N/A",
                "Tác giả": item.tacgia || "N/A",
                "Tổng số": item.tongso,
                "Còn lại": item.conlai
            }));

            const worksheet = XLSX.utils.json_to_sheet(excelData);
            
            // Định dạng Header căn giữa, màu xanh
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const addr = XLSX.utils.encode_cell({ r: 0, c: C });
                worksheet[addr].s = {
                    alignment: { horizontal: "center", vertical: "center" },
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "206095" } }
                };
            }

            // Auto-fit cột
            worksheet['!cols'] = Object.keys(excelData[0]).map(key => ({ width: 20 }));

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Kho Sách");
            
            const dateStr = new Date().toISOString().split('T')[0];
            XLSX.writeFile(workbook, `Kho_Sach_${dateStr}.xlsx`);
            Toast.fire({ icon: 'success', title: 'Đã xuất Excel!' });

        } catch (err) {
            Toast.fire({ icon: 'error', title: 'Lỗi xuất file!' });
        }
    }
</script>

</body>
</html>
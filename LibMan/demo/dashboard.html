<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Hệ thống Quản lý Thư viện</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="../style.css"> 
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="../auth.js"></script>
</head>
<body>
    <header id="header-placeholder" class="web-header"></header>
    
    <nav id="sidebar"></nav>

    <div class="main-content">
        <div class="dashboard-container">
            <div class="stats-section">
                <div class="welcome-section mb-4">
                    <h3 class="fw-bold">Hệ thống Quản lý</h3>
                    <p class="text-muted">Tổng quan tình hình thư viện hôm nay.</p>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card border-0 bg-primary text-white shadow-sm p-4">
                                <small class="text-white-50">Đang mượn</small>
                                <h2 id="count-muon" class="mb-0 fw-bold">0</h2>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 bg-danger text-white shadow-sm p-4">
                                <small class="text-white-50">Quá hạn</small>
                                <h2 id="count-overdue" class="mb-0 fw-bold">0</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="calendar-sidebar">
                <div class="calendar-card shadow-sm">
                    <h6 class="text-success fw-bold mb-3"><i class="bi bi-calendar3"></i> Hạn trả sách</h6>
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
    // 1. NẠP LAYOUT (HEADER & SIDEBAR)
    async function loadLayout() {
        try {
            const [hRes, sRes] = await Promise.all([
                fetch('header.html'),
                fetch('sidebar.html')
            ]);
            document.getElementById('header-placeholder').innerHTML = await hRes.text();
            document.getElementById('sidebar').innerHTML = await sRes.text();
            
            const activeLink = document.querySelector('#sidebar a[href="dashboard.html"]');
            if(activeLink) activeLink.parentElement.classList.add('active');
        } catch (e) { console.error("Lỗi nạp layout:", e); }
    }
    await loadLayout();

    // 2. HÀM KIỂM TRA VÀ HIỂN THỊ THÔNG BÁO (TOAST)
    function checkDeadlines(data) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // Lọc ra các phiếu mượn còn đúng hoặc ít hơn 3 ngày là đến hạn (nhưng chưa quá hạn)
        const upcomingDeadlines = data.filter(item => {
            const hanTra = new Date(item.han_tra);
            const diffTime = hanTra - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= 3 && diffDays >= 0; 
        });

        if (upcomingDeadlines.length > 0) {
            const Toast = Swal.mixin({
                toast: true,
                position: 'bottom-end', // Góc phải dưới
                showConfirmButton: false,
                timer: 5000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });

            Toast.fire({
                icon: 'warning',
                title: `Có ${upcomingDeadlines.length} yêu cầu sắp đến hạn trả!`,
                text: 'Vui lòng kiểm tra lịch để biết chi tiết.'
            });
        }
    }

    // 3. LOGIC LẤY DỮ LIỆU VÀ KHỞI TẠO LỊCH
    async function initDashboard() {
        try {
            const res = await fetch('/api/danh-sach-muon');
            const data = await res.json();
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Cập nhật số liệu thống kê
            document.getElementById('count-muon').innerText = data.length;
            document.getElementById('count-overdue').innerText = data.filter(item => {
                return new Date(item.han_tra) < today;
            }).length;

            // Gọi hàm kiểm tra thông báo
            checkDeadlines(data);

            // Khởi tạo FullCalendar
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'vi',
                firstDay: 1, 
                height: 'auto',
                headerToolbar: {
                    left: 'title',
                    center: '',
                    right: 'prev,next'
                },
                events: data.map(item => ({
                    title: item.hoten,
                    start: item.han_tra,
                    extendedProps: { tieude: item.tieude }
                })),

                dayCellDidMount: function(info) {
                    const dateStr = info.date.toLocaleDateString('en-CA');
                    const eventsToday = data.filter(i => {
                        const d = new Date(i.han_tra).toLocaleDateString('en-CA');
                        return d === dateStr;
                    });
                    
                    if (eventsToday.length > 0) {
                        info.el.classList.add('has-deadline');
                        const listPeople = eventsToday.map(e => `- ${e.hoten} (${e.tieude})`).join('\n');
                        info.el.setAttribute('title', `Hạn trả sách:\n${listPeople}`);
                    }
                },

                eventClick: function(info) {
                    Swal.fire({
                        title: 'Chi tiết hạn trả',
                        html: `<b>Người mượn:</b> ${info.event.title}<br>
                               <b>Tên sách:</b> ${info.event.extendedProps.tieude}`,
                        icon: 'info'
                    });
                }
            });
            calendar.render();

        } catch (error) {
            console.error("Lỗi:", error);
        }
    }
    initDashboard();

    // 4. XỬ LÝ ĐĂNG XUẤT
    document.addEventListener('click', function(e) {
        if (e.target.closest('#btnLogout')) {
            e.preventDefault();
            Swal.fire({
                title: 'Xác nhận đăng xuất?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#be1e2d',
                confirmButtonText: 'Đăng xuất'
            }).then((result) => {
                if (result.isConfirmed) window.location.href = 'login.html';
            });
        }
    });
});

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý Thư viện</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
</head>
<body>
<header class="web-header">
    <div class="header-content">
        <h1 class="logo">THƯ VIỆN TRƯỜNG CHÍNH TRỊ CẦN THƠ</h1>
    </div>
</header>

<nav id="sidebar">
    <ul class="list-unstyled components">
        <li class="active"><a href="/dashboard.html"><i class="bi bi-house-door"></i> Trang chủ</a></li>
        <li><a href="/muon.html"><i class="bi bi-person-plus-fill"></i> Cho mượn sách</a></li>
        <li><a href="/dsmuon.html"><i class="bi bi-list-columns-reverse"></i> Đang mượn</a></li>
        <li><a href="/lstra.html"><i class="bi bi-clock-history"></i> Lịch sử trả</a></li>
        <li><a href="/khosach.html"><i class="bi bi-archive"></i> Kho sách</a></li>
    </ul>
</nav>

<div class="main-content">
    <div class="dashboard-container">
        <div class="welcome-section">
            <h3 class="fw-bold">Hệ thống Quản lý</h3>
            <p class="text-muted">Tổng quan tình hình thư viện hôm nay.</p>
            <div class="row g-3 mt-2">
                <div class="col-6">
                    <div class="card border-0 bg-primary text-white shadow-sm p-3">
                        <small>Đang mượn</small>
                        <h2 id="count-muon" class="mb-0">0</h2>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card border-0 bg-danger text-white shadow-sm p-3">
                        <small>Quá hạn</small>
                        <h2 id="count-overdue" class="mb-0">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="calendar-section">
            <h6 class="text-success fw-bold"><i class="bi bi-calendar3"></i> Hạn trả sách</h6>
            <div id="calendar"></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function() {
        const todayStr = new Date().toLocaleDateString('en-CA');
        let eventsDataRaw = []; 

        async function fetchEvents() {
            try {
                const res = await fetch('/api/danh-sach-muon'); 
                const data = await res.json();
                eventsDataRaw = data; 
                
                document.getElementById('count-muon').innerText = data.length;
                const overdueCount = data.filter(item => {
                    const d = new Date(item.han_tra);
                    return d.toLocaleDateString('en-CA') < todayStr;
                }).length;
                document.getElementById('count-overdue').innerText = overdueCount;

                return data.map(item => {
                    let formattedDate;
                    if (typeof item.han_tra === 'string' && item.han_tra.includes('/')) {
                        const parts = item.han_tra.split('/');
                        formattedDate = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
                    } else {
                        formattedDate = new Date(item.han_tra).toLocaleDateString('en-CA');
                    }
                    return { title: item.hoten, start: formattedDate, description: item.tieude };
                });
            } catch (e) {
                // Dữ liệu giả định để test khi API lỗi
                return eventsDataRaw.map(item => ({ title: item.hoten, start: item.han_tra, description: item.tieude }));
            }
        }

        function notifyUpcoming(data, today) {
            const hasShown = sessionStorage.getItem('hasShownNotification');
            if (hasShown) return;

            const todayObj = new Date(today);
            todayObj.setHours(0,0,0,0);
            const limitObj = new Date(today);
            limitObj.setDate(todayObj.getDate() + 3); 
            limitObj.setHours(23,59,59,999);

            const upcoming = data.filter(item => {
                const d = new Date(item.han_tra);
                return d >= todayObj && d <= limitObj;
            });

            if (upcoming.length > 0) {
                Swal.fire({
                    toast: true,
                    position: 'bottom-end',
                    icon: 'warning',
                    title: `Có ${upcoming.length} phiếu mượn sắp quá hạn!`,
                    showConfirmButton: false,
                    timer: 5000,
                    timerProgressBar: true,
                    // Sử dụng class tùy chỉnh để chỉnh kích thước qua CSS
                    customClass: {
                        popup: 'huge-toast'
                    }
                });
                sessionStorage.setItem('hasShownNotification', 'true');
            }
        }

        // THỰC THI: Lấy dữ liệu và gọi thông báo
        const eventsData = await fetchEvents();
        notifyUpcoming(eventsDataRaw, todayStr);

        // KHỞI TẠO LỊCH
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'vi',
            titleFormat: { month: '2-digit', year: 'numeric' },
            height: 'auto',
            firstDay: 1, 
            initialDate: todayStr,
            fixedWeekCount: true,      
            showNonCurrentDates: true,
            headerToolbar: { left: 'prev', center: 'title', right: 'next' },
            dayCellDidMount: function(info) {
                const cellDate = info.date.toLocaleDateString('en-CA');
                const list = eventsData.filter(e => e.start === cellDate);
                if (list.length > 0) {
                    info.el.classList.add('has-deadline'); 
                    if (cellDate < todayStr) info.el.classList.add('is-overdue');
                    
                    info.el.addEventListener('mouseenter', function(e) {
                        const tooltip = document.createElement('div');
                        tooltip.id = 'calendar-tooltip';
                        let content = `<b>Hạn trả: ${cellDate}</b><hr style="margin:5px 0">`;
                        list.forEach(item => { content += `• ${item.title}: <i>${item.description}</i><br>`; });
                        tooltip.innerHTML = content;
                        document.body.appendChild(tooltip);
                        
                        const tooltipWidth = 220; 
                        const spaceRight = window.innerWidth - e.clientX;
                        if (spaceRight < tooltipWidth + 20) {
                            tooltip.style.left = (e.clientX - tooltipWidth - 15) + 'px';
                        } else {
                            tooltip.style.left = (e.clientX + 15) + 'px';
                        }
                        tooltip.style.top = (e.clientY + 15) + 'px';
                    });
                    info.el.addEventListener('mouseleave', () => {
                        const t = document.getElementById('calendar-tooltip');
                        if (t) t.remove();
                    });
                }
            }
        });
        calendar.render();
    });
</script>
</body>
</html>
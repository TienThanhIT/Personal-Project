<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch sử mượn</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <header class="web-header">
        <div class="header-content">
            <h1 class="logo">THƯ VIỆN TRƯỜNG CHÍNH TRỊ CẦN THƠ</h1>
        </div>
    </header>
    
    <nav id="sidebar">
        <ul class="list-unstyled components">
            <li><a href="/dashboard.html"><i class="bi bi-house-door"></i> Trang chủ</a></li>
            <li><a href="/muon.html"><i class="bi bi-person-plus-fill"></i> Cho mượn sách</a></li>
            <li class="active"><a href="/dsmuon.html"><i class="bi bi-list-columns-reverse"></i> Đang mượn</a></li>
            <li><a href="/lstra.html"><i class="bi bi-clock-history"></i> Lịch sử trả</a></li>
            <li><a href="/khosach.html"><i class="bi bi-archive"></i> Kho sách</a></li>
            <hr class="mx-3 border-secondary">
        </ul>
    </nav>

    <div class="main-content">
        <div class="container-fluid">
            <h3 class="mb-4 text-primary fw-bold text-center">DANH SÁCH ĐỘC GIẢ ĐANG MƯỢN</h3>
            
            <div class="table-container">
                <table class="table table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>STT</th>
                            <th>Họ tên người mượn</th>
                            <th>Tiêu đề sách</th>
                            <th>Ngày mượn</th>
                            <th>Hạn trả</th>
                            <th>Trạng thái</th>
                            <th class="text-center">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="listMuon"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Cấu hình Toast thông báo nhỏ
        const Toast = Swal.mixin({
            toast: true,
            position: 'bottom-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });

        // Hàm tải danh sách
        async function loadDanhSach() {
            try {
                const res = await fetch('/api/danh-sach-muon');
                const data = await res.json();
                const listBody = document.getElementById('listMuon');
                
                if (data.length === 0) {
                    listBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted">Hiện chưa có ai mượn sách.</td></tr>`;
                    return;
                }

               const html = data.map((item, index) => {
                // 1. Chuẩn hóa Ngày Hiện Tại (về 0h 0p 0s)
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                // 2. Chuẩn hóa Hạn Trả (về 0h 0p 0s)
                const dHanTraRaw = new Date(item.han_tra);
                const dHanTra = new Date(dHanTraRaw.getFullYear(), dHanTraRaw.getMonth(), dHanTraRaw.getDate());

                // 3. Logic: Quá hạn khi Ngày hiện tại LỚN HƠN Hạn trả
                // Nếu hôm nay là 2/2/2026 và hạn trả là 1/2/2026 -> Quá hạn
                const isOverdue = today > dHanTra && item.trang_thai !== 'Đã trả';
                
                const statusClass = isOverdue ? 'badge bg-danger' : 'badge bg-success';
                const statusText = isOverdue ? 'Quá hạn' : 'Đang mượn';

                return `
                    <tr>
                        <td class="fw-bold text-muted">${index + 1}</td> 
                        <td>
                            <div class="fw-bold">${item.hoten}</div>
                            <small class="text-muted">Mã phiếu: #${item.phieu_id}</small>
                        </td>
                        <td>${item.tieude}</td>
                        <td>${new Date(item.ngay_muon).toLocaleDateString('vi-VN')}</td>
                        <td>${dHanTra.toLocaleDateString('vi-VN')}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-primary" onclick="traSach(${item.phieu_id})">
                                <i class="bi bi-check2-circle"></i> Trả sách
                            </button>
                        </td>
                    </tr>`;
            }).join('');
                listBody.innerHTML = html;
            } catch (err) {
                document.getElementById('listMuon').innerHTML = `<tr><td colspan="7" class="text-center text-danger">Lỗi kết nối Server!</td></tr>`;
            }
        }

        // Hàm xử lý trả sách với Pop-up xác nhận giữa màn hình
        async function traSach(phieu_id) {
            const result = await Swal.fire({
                title: 'Xác nhận trả sách?',
                text: "Hệ thống sẽ ghi nhận sách đã được hoàn trả và cập nhật kho.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#2e7d32',
                cancelButtonColor: '#d33',
                confirmButtonText: 'OK',
                cancelButtonText: 'Hủy'
            });

            if (result.isConfirmed) {
                try {
                    const res = await fetch('/api/tra-sach', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phieu_id })
                    });

                    if (res.ok) {
                        // Hiện thông báo nhỏ thành công ở góc phải
                        Toast.fire({
                            icon: 'success',
                            title: 'Đã cập nhật trạng thái trả sách!'
                        });
                        loadDanhSach(); // Tải lại bảng
                    } else {
                        throw new Error();
                    }
                } catch (error) {
                    Swal.fire('Lỗi!', 'Không thể thực hiện thao tác trả sách.', 'error');
                }
            }
        }

        loadDanhSach();
    </script>
</body>
</html>